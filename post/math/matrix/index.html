<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer-when-downgrade"><title>矩阵乘法及应用 | PigAunt的博客</title><meta property="og:title" content="矩阵乘法及应用 - PigAunt的博客"><meta property="og:type" content="article"><meta property="article:published_time" content="2022-02-10T16:50:42+08:00"><meta property="article:modified_time" content="2022-02-10T16:50:42+08:00"><meta name=Keywords content="C++,OI,C#"><meta name=description content="矩阵乘法及应用"><meta name=author content="PigAunt"><meta property="og:url" content="https://www.pigaunt.top/post/math/matrix/"><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><link rel=stylesheet href=/css/normalize.css><link rel=stylesheet href=/css/style.css><script type=text/javascript src=//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js></script><link rel=stylesheet href=/css/douban.css><link rel=stylesheet href=/css/other.css></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><a id=logo href=https://www.pigaunt.top>PigAunt的博客</a><p class=description>Hello, World!</p></div><div><nav id=nav-menu class=clearfix><a class=current href=https://www.pigaunt.top>首页</a>
<a href=https://www.pigaunt.top/archives/ title=归档>归档</a>
<a href=https://www.pigaunt.top/about/ title=关于>关于</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>矩阵乘法及应用</h1></header><date class="post-meta meta-date">2022年2月10日</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=/categories/%E6%95%B0%E5%AD%A6>数学</a></span></div><div class=post-meta><span id=busuanzi_container_page_pv>|<span id=busuanzi_value_page_pv></span><span>
阅读</span></span></div><div class=post-content><h1 id=矩阵乘法及应用>矩阵乘法及应用</h1><h2 id=肤浅地认识下矩阵>肤浅地认识下矩阵</h2><p>至少从表面上看，矩阵是一个二维数组。矩阵的加减法就是在相同的位置上进行加减，即：</p><p>$$
C_{i, j} = A_{i, j} + B_{i, j}
$$</p><p>其中矩阵 $A$，$B$ 和 $C$ 的行数和列数都是相同的。</p><p>而矩阵的乘法显得有些不同，如果 $A$ 是 $n \times m$ 矩阵，$B$ 是 $m \times p$ 矩阵，那么 $C = A \times B$ 是 $n \times p$ 矩阵，且：</p><p>$$
C_{i, j} = \sum_{k = 1}^m A_{i, k} \times B_{k, j}
$$</p><p>和加减法相同位置操作不同，$C$ 中每个数 $x$ 是由 $A$ 中与 $x$ 同行的数和 $B$ 中与 $x$ 同列的数相乘的和，这实际上是在体现一种<strong>变换</strong>，把 $A$ 的一行看作一个向量（可以先理解成一行数，并把某一列的数称作<strong>某一维</strong>的数），那么 $A \times B$ 就是让 $A$ 中某一行的一个向量按照矩阵 $B$ 所体现的变换规则变换成另一个向量，因此让每一维的数去乘 $B$ 中每一维所需变换的值，就比较有道理了（由于本人水平太低，没法解释得很清楚，建议阅读神犇孟岩老师的 <a href=https://blog.csdn.net/myan/article/details/647511>理解矩阵</a>）。</p><p>而我们利用矩阵乘法，正是通过构造矩阵来体现变换，从而实现一维状态的递推。而矩阵乘法满足交换律，这使得我们在需要多次递推时，将快速幂应用于矩阵乘法中，从而加速递推。</p><h2 id=两个例题>两个例题</h2><h3 id=acwing-205-斐波那契httpswwwacwingcomproblemcontent207><a href=https://www.acwing.com/problem/content/207/>AcWing-205-斐波那契</a></h3><p>本题是经典的求斐波那契数列第 $n$ 项的问题，但数据范围扩大到了 $10 ^ 9$，并且有多组数据，$O(n)$ 是会超时的。结合前面提到的矩阵，我们可以思考如何将斐波那契数列递推公式 $f_i = f_{i - 1} + f_{i - 2}$ 转换为向量 $f$ 与矩阵 $A$ 相乘的形式。</p><p>由于某一项实际上只与前两项相关，我们只需要在向量 $f$ 中保留两项，即 $f = (f_i, f_{i + 1})$，这时我们要造出下一个 $f = (f_{i + 1}, f_i)$，那么新的 $f$ 中第一个位置应当是原 $f$ 中两个数的和，为了保留它们，我们把 $A$ 的第一列构造为 $1$；而 $f$ 中第二个位置只需要保留原 $f$ 中的后一项，因此我们把 $A$ 的第二列构造为 $(0, 1)$，这样，原来的递推过程转化为了：</p><p>$$
f' = f \times \begin{pmatrix} 1 & 1 \cr 0 & 1 \end{pmatrix}
$$</p><p>这样我们可以对上述公式应用快速幂：矩阵乘法是 $O(n ^ 3)$ 的，在本题中 $n = 2$，复杂度为常数，因此总共的时间复杂度是 $O(\log_2 n)$，可以通过本题。</p><p>参考代码：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">65
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">66
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">67
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">68
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">69
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">70
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">71
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">72
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">73
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">74
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">75
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">76
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">77
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">78
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">79
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">80
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">81
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">82
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">83
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">84
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">85
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">86
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">87
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">88
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">89
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=color:#ff79c6>#include</span> <span style=color:#ff79c6>&lt;iostream&gt;</span><span style=color:#ff79c6>
</span><span style=color:#ff79c6></span>
<span style=color:#ff79c6>class</span> <span style=color:#50fa7b>Matrix</span>
{
<span style=color:#ff79c6>public</span><span style=color:#ff79c6>:</span>
    <span style=color:#ff79c6>const</span> <span style=color:#ff79c6>static</span> <span style=color:#8be9fd>int</span> N <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>5</span>, MOD <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>10000</span>;
    <span style=color:#8be9fd>int</span> val[N][N], line, col;

    Matrix(<span style=color:#8be9fd>int</span> line, <span style=color:#8be9fd>int</span> col)
        <span style=color:#ff79c6>:</span> line(line), col(col)
    {
        <span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; i <span style=color:#ff79c6>&lt;</span> line; i<span style=color:#ff79c6>++</span>)
            <span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> j <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; j <span style=color:#ff79c6>&lt;</span> col; j<span style=color:#ff79c6>++</span>)
                val[i][j] <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
    }
    
    <span style=color:#6272a4>// Matrix operator+(const Matrix&amp; mat) const
</span><span style=color:#6272a4></span>    <span style=color:#6272a4>// {
</span><span style=color:#6272a4></span>    <span style=color:#6272a4>//     if (line != mat.line || col != mat.col)
</span><span style=color:#6272a4></span>    <span style=color:#6272a4>//         return Matrix(0, 0);
</span><span style=color:#6272a4></span>    <span style=color:#6272a4>//     Matrix res(line, col);
</span><span style=color:#6272a4></span>    <span style=color:#6272a4>//     for (int i = 0; i &lt; line; i++)
</span><span style=color:#6272a4></span>    <span style=color:#6272a4>//         for (int j = 0; j &lt; col; j++)
</span><span style=color:#6272a4></span>    <span style=color:#6272a4>//             res.val[i][j] = ((long long)val[i][j] + mat.val[i][j]) % MOD;
</span><span style=color:#6272a4></span>    <span style=color:#6272a4>//     return res;
</span><span style=color:#6272a4></span>    <span style=color:#6272a4>// }
</span><span style=color:#6272a4></span>
    <span style=color:#6272a4>// Matrix operator-(const Matrix&amp; mat) const
</span><span style=color:#6272a4></span>    <span style=color:#6272a4>// {
</span><span style=color:#6272a4></span>    <span style=color:#6272a4>//     if (line != mat.line || col != mat.col)
</span><span style=color:#6272a4></span>    <span style=color:#6272a4>//         return Matrix(0, 0);
</span><span style=color:#6272a4></span>    <span style=color:#6272a4>//     Matrix res(line, col);
</span><span style=color:#6272a4></span>    <span style=color:#6272a4>//     for (int i = 0; i &lt; line; i++)
</span><span style=color:#6272a4></span>    <span style=color:#6272a4>//         for (int j = 0; j &lt; col; j++)
</span><span style=color:#6272a4></span>    <span style=color:#6272a4>//             res.val[i][j] = ((long long)val[i][j] - mat.val[i][j]) % MOD;
</span><span style=color:#6272a4></span>    <span style=color:#6272a4>//     return res;
</span><span style=color:#6272a4></span>    <span style=color:#6272a4>// }
</span><span style=color:#6272a4></span>
    Matrix <span style=color:#ff79c6>operator</span><span style=color:#ff79c6>*</span>(<span style=color:#ff79c6>const</span> Matrix<span style=color:#ff79c6>&amp;</span> mat) <span style=color:#ff79c6>const</span>
    {
        <span style=color:#ff79c6>if</span> (col <span style=color:#ff79c6>!=</span> mat.line)
            <span style=color:#ff79c6>return</span> Matrix(<span style=color:#bd93f9>0</span>, <span style=color:#bd93f9>0</span>);
        Matrix <span style=color:#50fa7b>res</span>(line, mat.col);
        <span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; i <span style=color:#ff79c6>&lt;</span> line; i<span style=color:#ff79c6>++</span>)
            <span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> j <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; j <span style=color:#ff79c6>&lt;</span> mat.col; j<span style=color:#ff79c6>++</span>)
                <span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> k <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; k <span style=color:#ff79c6>&lt;</span> col; k<span style=color:#ff79c6>++</span>)
                    res.val[i][j] <span style=color:#ff79c6>=</span> ((<span style=color:#8be9fd>long</span> <span style=color:#8be9fd>long</span>)res.val[i][j] <span style=color:#ff79c6>+</span> (<span style=color:#8be9fd>long</span> <span style=color:#8be9fd>long</span>)val[i][k] <span style=color:#ff79c6>*</span> mat.val[k][j]) <span style=color:#ff79c6>%</span> MOD;
        <span style=color:#ff79c6>return</span> res;
    }

    Matrix <span style=color:#ff79c6>operator</span><span style=color:#ff79c6>^</span>(<span style=color:#8be9fd>int</span> k) <span style=color:#ff79c6>const</span>
    {
        <span style=color:#ff79c6>if</span> (line <span style=color:#ff79c6>!=</span> col)
            <span style=color:#ff79c6>return</span> Matrix(<span style=color:#bd93f9>0</span>, <span style=color:#bd93f9>0</span>);
        Matrix <span style=color:#50fa7b>res</span>(line, col), mat <span style=color:#ff79c6>=</span> (<span style=color:#ff79c6>*</span><span style=color:#ff79c6>this</span>);
        <span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; i <span style=color:#ff79c6>&lt;</span> line; i<span style=color:#ff79c6>++</span>)
            res.val[i][i] <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>;
        <span style=color:#ff79c6>while</span> (k <span style=color:#ff79c6>&gt;</span> <span style=color:#bd93f9>0</span>)
        {
            <span style=color:#ff79c6>if</span> (k <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>1</span>)
                res <span style=color:#ff79c6>=</span> (res <span style=color:#ff79c6>*</span> mat);
            mat <span style=color:#ff79c6>=</span> (mat <span style=color:#ff79c6>*</span> mat);
            k <span style=color:#ff79c6>&gt;&gt;=</span> <span style=color:#bd93f9>1</span>;
        }
        <span style=color:#ff79c6>return</span> res;
    }
};

<span style=color:#8be9fd>int</span> n;
Matrix <span style=color:#50fa7b>f</span>(<span style=color:#bd93f9>1</span>, <span style=color:#bd93f9>2</span>), A(<span style=color:#bd93f9>2</span>, <span style=color:#bd93f9>2</span>);

<span style=color:#8be9fd>int</span> <span style=color:#50fa7b>main</span>()
{
    <span style=color:#ff79c6>while</span> (<span style=color:#8be9fd;font-style:italic>true</span>)
    {
        std<span style=color:#ff79c6>::</span>cin <span style=color:#ff79c6>&gt;&gt;</span> n;
        <span style=color:#ff79c6>if</span> (n <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>-</span><span style=color:#bd93f9>1</span>)
            <span style=color:#ff79c6>return</span> <span style=color:#bd93f9>0</span>;
            
        f.val[<span style=color:#bd93f9>0</span>][<span style=color:#bd93f9>0</span>] <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>, f.val[<span style=color:#bd93f9>0</span>][<span style=color:#bd93f9>1</span>] <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>;
        A.val[<span style=color:#bd93f9>0</span>][<span style=color:#bd93f9>0</span>] <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>, A.val[<span style=color:#bd93f9>0</span>][<span style=color:#bd93f9>1</span>] <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>, A.val[<span style=color:#bd93f9>1</span>][<span style=color:#bd93f9>0</span>] <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>, A.val[<span style=color:#bd93f9>1</span>][<span style=color:#bd93f9>1</span>] <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>;
    
        A <span style=color:#ff79c6>=</span> (A <span style=color:#ff79c6>^</span> n);
        f <span style=color:#ff79c6>=</span> (f <span style=color:#ff79c6>*</span> A);
    
        std<span style=color:#ff79c6>::</span>cout <span style=color:#ff79c6>&lt;&lt;</span> f.val[<span style=color:#bd93f9>0</span>][<span style=color:#bd93f9>0</span>] <span style=color:#ff79c6>&lt;&lt;</span> std<span style=color:#ff79c6>::</span>endl;
    }
    <span style=color:#ff79c6>return</span> <span style=color:#bd93f9>0</span>;
}
</code></pre></td></tr></table></div></div><h3 id=acwing-206-石头游戏httpswwwacwingcomproblemcontent208><a href=https://www.acwing.com/problem/content/208/>AcWing-206-石头游戏</a></h3><p>现在是一个二维的棋盘了，是不是就不符合前面所说的一维递推了呢？确实，但是我们发现 $0 \le m, n \le 8$，因此可以采用二维化一维，即令 $\mathrm{Index}(x, y) = (x - 1) \times m + y$，给每个坐标一个一维的数字编号。</p><p>这时题目中的变换就不难构造了。首先，上下左右的移动，以向上为例，可以设置变换矩阵 $A$ 的第 $\mathrm{Index}(x, y)$ 行，第 $\mathrm{Index}(x - 1, y)$ 列（$x > 1$）为 $1$。</p><p>那么添加石头呢？我们需要一个不与其它坐标冲突的位置作为石头来源，这里让 $A_{0, 0}$ 为 $1$，为其它格子提供石头。如果要放 $i$ 个石头，就让 $A$ 的第 $0$ 行，第 $\mathrm{Index}(x, y)$ 列为 $i$。同时，为了保证原来的石头还在，$A$ 的第 $\mathrm{Index}(x, y)$ 行，第 $\mathrm{Index}(x, y)$ 列应当为 $1$。</p><p>$A$ 的其它位置均设置为 $0$。</p><p>这时仔细想想会发现，丢弃石头其实不需要考虑，因为只有上面两类变换保留了石头。</p><p>不过本题还有一个时间维度，只需要构造多个矩阵满足不同时刻的变换即可。这里有一个偷懒的地方：由于操作序列长度不超过 $6$，所有长度的最小公倍数最大就是 $60$，所以把前 $60$ 个时刻的变换矩阵求出来，后面一定都是可以复用的，省去了求最小公倍数的步骤。</p><p>最后，使用快速幂加速递推，我们便可以通过本题。</p><p>要特别注意的是：矩阵中的“$1$”（单位矩阵，只对于行数和列数相同的有定义）不是全为 $0$ 的矩阵，而是主对角线（左上到右下）为 $1$ 的矩阵（意义是保留向量每一维上的原有值），千万不要忘记初始化了。</p><p>参考代码：</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">100
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">101
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">102
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">103
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">104
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">105
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">106
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">107
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">108
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">109
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">110
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">111
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">112
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">113
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">114
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">115
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">116
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">117
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">118
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">119
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">120
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">121
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">122
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">123
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">124
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">125
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">126
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">127
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">128
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=color:#ff79c6>#include</span> <span style=color:#ff79c6>&lt;iostream&gt;</span><span style=color:#ff79c6>
</span><span style=color:#ff79c6></span>
<span style=color:#ff79c6>const</span> <span style=color:#8be9fd>int</span> N <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>8</span> <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>5</span>, K <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>60</span>;

<span style=color:#ff79c6>class</span> <span style=color:#50fa7b>Matrix</span>
{
<span style=color:#ff79c6>public</span><span style=color:#ff79c6>:</span>
    <span style=color:#ff79c6>const</span> <span style=color:#ff79c6>static</span> <span style=color:#8be9fd>int</span> L <span style=color:#ff79c6>=</span> N <span style=color:#ff79c6>*</span> N;
    <span style=color:#8be9fd>int</span> line, col;
    <span style=color:#8be9fd>long</span> <span style=color:#8be9fd>long</span> val[L][L];

    Matrix() {}
    Matrix(<span style=color:#8be9fd>int</span> line, <span style=color:#8be9fd>int</span> col)
        <span style=color:#ff79c6>:</span> line(line), col(col)
    {
        <span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; i <span style=color:#ff79c6>&lt;</span> line; i<span style=color:#ff79c6>++</span>)
            <span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> j <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; j <span style=color:#ff79c6>&lt;</span> col; j<span style=color:#ff79c6>++</span>)
                val[i][j] <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
    }

    Matrix <span style=color:#ff79c6>operator</span><span style=color:#ff79c6>*</span>(<span style=color:#ff79c6>const</span> Matrix<span style=color:#ff79c6>&amp;</span> mat) <span style=color:#ff79c6>const</span>
    {
        <span style=color:#ff79c6>if</span> (col <span style=color:#ff79c6>!=</span> mat.line)
            <span style=color:#ff79c6>return</span> Matrix(<span style=color:#bd93f9>0</span>, <span style=color:#bd93f9>0</span>);
        Matrix <span style=color:#50fa7b>res</span>(line, mat.col);
        <span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; i <span style=color:#ff79c6>&lt;</span> line; i<span style=color:#ff79c6>++</span>)
            <span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> j <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; j <span style=color:#ff79c6>&lt;</span> mat.col; j<span style=color:#ff79c6>++</span>)
                <span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> k <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; k <span style=color:#ff79c6>&lt;</span> col; k<span style=color:#ff79c6>++</span>)
                    res.val[i][j] <span style=color:#ff79c6>+=</span> val[i][k] <span style=color:#ff79c6>*</span> mat.val[k][j];
        <span style=color:#ff79c6>return</span> res;
    }

    Matrix <span style=color:#ff79c6>operator</span><span style=color:#ff79c6>^</span>(<span style=color:#8be9fd>int</span> k) <span style=color:#ff79c6>const</span>
    {
        <span style=color:#ff79c6>if</span> (line <span style=color:#ff79c6>!=</span> col)
            <span style=color:#ff79c6>return</span> Matrix(<span style=color:#bd93f9>0</span>, <span style=color:#bd93f9>0</span>);
        Matrix <span style=color:#50fa7b>res</span>(line, col), mat <span style=color:#ff79c6>=</span> (<span style=color:#ff79c6>*</span><span style=color:#ff79c6>this</span>);
        <span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; i <span style=color:#ff79c6>&lt;</span> line; i<span style=color:#ff79c6>++</span>)
            res.val[i][i] <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>;
        <span style=color:#ff79c6>while</span> (k <span style=color:#ff79c6>&gt;</span> <span style=color:#bd93f9>0</span>)
        {
            <span style=color:#ff79c6>if</span> (k <span style=color:#ff79c6>&amp;</span> <span style=color:#bd93f9>1</span>)
                res <span style=color:#ff79c6>=</span> (res <span style=color:#ff79c6>*</span> mat);
            mat <span style=color:#ff79c6>=</span> (mat <span style=color:#ff79c6>*</span> mat);
            k <span style=color:#ff79c6>&gt;&gt;=</span> <span style=color:#bd93f9>1</span>;
        }
        <span style=color:#ff79c6>return</span> res;
    }
};

<span style=color:#8be9fd>int</span> n, m, len, T, act;
<span style=color:#8be9fd>int</span> opt[N][N];
Matrix trans[K <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>5</span>], transd, f;
std<span style=color:#ff79c6>::</span>string op[N];

<span style=color:#ff79c6>inline</span> <span style=color:#8be9fd>int</span> <span style=color:#50fa7b>GetIndex</span>(<span style=color:#8be9fd>int</span> x, <span style=color:#8be9fd>int</span> y) { <span style=color:#ff79c6>return</span> (x <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>) <span style=color:#ff79c6>*</span> n <span style=color:#ff79c6>+</span> y; }

<span style=color:#8be9fd>void</span> <span style=color:#50fa7b>Init</span>()
{
    transd <span style=color:#ff79c6>=</span> Matrix(len <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>1</span>, len <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>1</span>);
    f <span style=color:#ff79c6>=</span> Matrix(<span style=color:#bd93f9>1</span>, len <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>1</span>);
    f.val[<span style=color:#bd93f9>0</span>][<span style=color:#bd93f9>0</span>] <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>;
    <span style=color:#6272a4>// 周期最大就是 60，懒得求最小公倍数了。
</span><span style=color:#6272a4></span>    <span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> ts <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; ts <span style=color:#ff79c6>&lt;</span> K; ts<span style=color:#ff79c6>++</span>)
    {
        trans[ts] <span style=color:#ff79c6>=</span> Matrix(len <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>1</span>, len <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>1</span>);
        trans[ts].val[<span style=color:#bd93f9>0</span>][<span style=color:#bd93f9>0</span>] <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>;
        <span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>; i <span style=color:#ff79c6>&lt;=</span> n; i<span style=color:#ff79c6>++</span>)
            <span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> j <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>; j <span style=color:#ff79c6>&lt;=</span> m; j<span style=color:#ff79c6>++</span>)
            {
                <span style=color:#8be9fd>int</span> pos <span style=color:#ff79c6>=</span> GetIndex(i, j);
                std<span style=color:#ff79c6>::</span>string<span style=color:#ff79c6>&amp;</span> lop <span style=color:#ff79c6>=</span> op[opt[i][j]];
                <span style=color:#8be9fd>char</span> sop <span style=color:#ff79c6>=</span> lop[ts <span style=color:#ff79c6>%</span> lop.length()];
                <span style=color:#ff79c6>if</span> (sop <span style=color:#ff79c6>&gt;=</span> <span style=color:#f1fa8c>&#39;0&#39;</span> <span style=color:#ff79c6>&amp;&amp;</span> sop <span style=color:#ff79c6>&lt;=</span> <span style=color:#f1fa8c>&#39;9&#39;</span>)
                {
                    trans[ts].val[<span style=color:#bd93f9>0</span>][pos] <span style=color:#ff79c6>=</span> sop <span style=color:#ff79c6>-</span> <span style=color:#f1fa8c>&#39;0&#39;</span>;
                    trans[ts].val[pos][pos] <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>;
                }
                <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (sop <span style=color:#ff79c6>==</span> <span style=color:#f1fa8c>&#39;N&#39;</span> <span style=color:#ff79c6>&amp;&amp;</span> i <span style=color:#ff79c6>&gt;</span> <span style=color:#bd93f9>1</span>)
                    trans[ts].val[pos][GetIndex(i <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>, j)] <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>;
                <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (sop <span style=color:#ff79c6>==</span> <span style=color:#f1fa8c>&#39;S&#39;</span> <span style=color:#ff79c6>&amp;&amp;</span> i <span style=color:#ff79c6>&lt;</span> n)
                    trans[ts].val[pos][GetIndex(i <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>1</span>, j)] <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>;
                <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (sop <span style=color:#ff79c6>==</span> <span style=color:#f1fa8c>&#39;W&#39;</span> <span style=color:#ff79c6>&amp;&amp;</span> j <span style=color:#ff79c6>&gt;</span> <span style=color:#bd93f9>1</span>)
                    trans[ts].val[pos][GetIndex(i, j <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>)] <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>;
                <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (sop <span style=color:#ff79c6>==</span> <span style=color:#f1fa8c>&#39;E&#39;</span> <span style=color:#ff79c6>&amp;&amp;</span> j <span style=color:#ff79c6>&lt;</span> m)
                    trans[ts].val[pos][GetIndex(i, j <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>1</span>)] <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>;
            }
    }
}

<span style=color:#8be9fd>long</span> <span style=color:#8be9fd>long</span> <span style=color:#50fa7b>Solve</span>()
{
    <span style=color:#8be9fd>int</span> r <span style=color:#ff79c6>=</span> T <span style=color:#ff79c6>%</span> K;
    <span style=color:#8be9fd>int</span> d <span style=color:#ff79c6>=</span> T <span style=color:#ff79c6>/</span> K;
    <span style=color:#6272a4>// 一定要初始化 transd，否则乘出来都是 0。
</span><span style=color:#6272a4></span>    <span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; i <span style=color:#ff79c6>&lt;=</span> len; i<span style=color:#ff79c6>++</span>)
        transd.val[i][i] <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>;
    <span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> ts <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; ts <span style=color:#ff79c6>&lt;</span> K; ts<span style=color:#ff79c6>++</span>)
        transd <span style=color:#ff79c6>=</span> transd <span style=color:#ff79c6>*</span> trans[ts];
    f <span style=color:#ff79c6>=</span> f <span style=color:#ff79c6>*</span> (transd <span style=color:#ff79c6>^</span> d);
    <span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> ts <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; ts <span style=color:#ff79c6>&lt;</span> r; ts<span style=color:#ff79c6>++</span>)
        f <span style=color:#ff79c6>=</span> f <span style=color:#ff79c6>*</span> trans[ts];
    <span style=color:#8be9fd>long</span> <span style=color:#8be9fd>long</span> res <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
    <span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>; i <span style=color:#ff79c6>&lt;=</span> len; i<span style=color:#ff79c6>++</span>)
        res <span style=color:#ff79c6>=</span> std<span style=color:#ff79c6>::</span>max(res, f.val[<span style=color:#bd93f9>0</span>][i]);
    <span style=color:#ff79c6>return</span> res;
}

<span style=color:#8be9fd>int</span> <span style=color:#50fa7b>main</span>()
{
    std<span style=color:#ff79c6>::</span>ios<span style=color:#ff79c6>::</span>sync_with_stdio(<span style=color:#8be9fd;font-style:italic>false</span>);

    std<span style=color:#ff79c6>::</span>cin <span style=color:#ff79c6>&gt;&gt;</span> n <span style=color:#ff79c6>&gt;&gt;</span> m <span style=color:#ff79c6>&gt;&gt;</span> T <span style=color:#ff79c6>&gt;&gt;</span> act;
    len <span style=color:#ff79c6>=</span> n <span style=color:#ff79c6>*</span> m;
    <span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>; i <span style=color:#ff79c6>&lt;=</span> n; i<span style=color:#ff79c6>++</span>)
    {
        std<span style=color:#ff79c6>::</span>string str;
        std<span style=color:#ff79c6>::</span>cin <span style=color:#ff79c6>&gt;&gt;</span> str;
        <span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> j <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>; j <span style=color:#ff79c6>&lt;=</span> m; j<span style=color:#ff79c6>++</span>)
            opt[i][j] <span style=color:#ff79c6>=</span> str[j <span style=color:#ff79c6>-</span> <span style=color:#bd93f9>1</span>] <span style=color:#ff79c6>-</span> <span style=color:#f1fa8c>&#39;0&#39;</span>;
    }
    <span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> i <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>; i <span style=color:#ff79c6>&lt;</span> act; i<span style=color:#ff79c6>++</span>)
        std<span style=color:#ff79c6>::</span>cin <span style=color:#ff79c6>&gt;&gt;</span> op[i];
    Init();

    std<span style=color:#ff79c6>::</span>cout <span style=color:#ff79c6>&lt;&lt;</span> Solve() <span style=color:#ff79c6>&lt;&lt;</span> std<span style=color:#ff79c6>::</span>endl;
    <span style=color:#ff79c6>return</span> <span style=color:#bd93f9>0</span>;
}
</code></pre></td></tr></table></div></div></div><div class=post-archive><ul class=post-copyright><li><strong>原文作者：</strong><a rel=author href=https://www.pigaunt.top>PigAunt</a></li><li style=word-break:break-all><strong>原文链接：</strong><a href=https://www.pigaunt.top/post/math/matrix/>https://www.pigaunt.top/post/math/matrix/</a></li><li><strong>版权声明：</strong>本作品采用<a rel=license href>知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可，非商业转载请注明出处（作者，原文链接）并按照相同协议共享，禁止商业转载。</li></ul></div><br><div class=post-archive><h2>See Also</h2><ul class=listing><li><a href=/post/math/seq-limit/>数列极限</a></li><li><a href=/post/string/z-algorithm/>Z 函数及其求法（扩展 KMP）</a></li><li><a href=/post/string/palindrome-and-manacher-algorithm/>回文字符串和 Manacher 算法</a></li><li><a href=/post/dp/tree-dp/>树形动态规划</a></li><li><a href=/post/dp/dp-on-numbers/>数位型动态规划</a></li></ul></div><div class="post-meta meta-tags"><ul class=clearfix><li><a href=/tags/%E6%95%B0%E5%AD%A6>数学</a></li></ul></div></article></div><footer id=footer><div>&copy; 2022 <a href=https://www.pigaunt.top>PigAunt的博客 By PigAunt</a></div><br><div><div class=github-badge><a href=https://gohugo.io/ target=_black rel=nofollow><span class=badge-subject>Powered by</span><span class="badge-value bg-blue">Hugo</span></a></div><div class=github-badge><a href=https://www.flysnow.org/ target=_black><span class=badge-subject>Design by</span><span class="badge-value bg-brightgreen">飞雪无情</span></a></div><div class=github-badge><a href=https://github.com/flysnow-org/maupassant-hugo target=_black><span class=badge-subject>Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a></div></div></footer><script type=text/javascript>window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:!0}}</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src="/js/totop.js?v=0.0.0" async></script><script type=text/javascript src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js async></script><script src=/js/douban.js></script></div><div id=secondary><section class=widget><form id=search action=https://www.pigaunt.top/search/ method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=Search>
<input type=hidden name=sitesearch value=https://www.pigaunt.top>
<button type=submit class="submit icon-search"></button></form></section><section class=widget><h3 class=widget-title>最近文章</h3><ul class=widget-list><li><a href=https://www.pigaunt.top/post/math/seq-limit/ title=数列极限>数列极限</a></li><li><a href=https://www.pigaunt.top/post/math/matrix/ title=矩阵乘法及应用>矩阵乘法及应用</a></li><li><a href=https://www.pigaunt.top/post/string/z-algorithm/ title="Z 函数及其求法（扩展 KMP）">Z 函数及其求法（扩展 KMP）</a></li><li><a href=https://www.pigaunt.top/post/string/palindrome-and-manacher-algorithm/ title="回文字符串和 Manacher 算法">回文字符串和 Manacher 算法</a></li><li><a href=https://www.pigaunt.top/post/dp/tree-dp/ title=树形动态规划>树形动态规划</a></li><li><a href=https://www.pigaunt.top/post/dp/dp-on-numbers/ title=数位型动态规划>数位型动态规划</a></li><li><a href=https://www.pigaunt.top/post/dp/state-compressed-dp/ title=状态压缩的动态规划>状态压缩的动态规划</a></li><li><a href=https://www.pigaunt.top/post/data-structure/monotonous-queue/ title=单调队列>单调队列</a></li><li><a href=https://www.pigaunt.top/post/dp/lis-and-lcs-problem/ title=LIS和LCS>LIS和LCS</a></li><li><a href=https://www.pigaunt.top/post/dp/range-dp/ title=区间型动态规划>区间型动态规划</a></li></ul></section><section class=widget><h3 class=widget-title><a href=/categories/>分类</a></h3><ul class=widget-list><li><a href=https://www.pigaunt.top/categories/misc/>misc (1)</a></li><li><a href=https://www.pigaunt.top/categories/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/>动态规划 (10)</a></li><li><a href=https://www.pigaunt.top/categories/%E5%AD%97%E7%AC%A6%E4%B8%B2/>字符串 (2)</a></li><li><a href=https://www.pigaunt.top/categories/%E6%95%B0%E5%AD%A6/>数学 (2)</a></li><li><a href=https://www.pigaunt.top/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/>数据结构 (1)</a></li></ul></section><section class=widget><h3 class=widget-title><a href=/tags/>标签</a></h3><div class=tagcloud><a href=https://www.pigaunt.top/tags/misc/>misc</a>
<a href=https://www.pigaunt.top/tags/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/>动态规划</a>
<a href=https://www.pigaunt.top/tags/%E5%AD%97%E7%AC%A6%E4%B8%B2/>字符串</a>
<a href=https://www.pigaunt.top/tags/%E6%95%B0%E5%AD%A6/>数学</a>
<a href=https://www.pigaunt.top/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/>数据结构</a></div></section><section class=widget><h3 class=widget-title>友情链接</h3><ul class=widget-list><li><a target=_blank href=https://rusun.blog.luogu.org/ title=RuSun的博客>RuSun的博客</a></li></ul></section><section class=widget><h3 class=widget-title>其它</h3><ul class=widget-list><li><a href=https://www.pigaunt.top/index.xml>文章 RSS</a></li></ul></section></div></div></div></div></body></html>